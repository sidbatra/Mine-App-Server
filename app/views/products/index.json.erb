<%-cache @key do-%>
  <%-if @filter == :user || @filter == :wanted-%>
    <%=@products.to_json(
        :only     => [:id,:is_gift,:handle,
                        :user_id,:category_id],
        :methods  => [:giant_url,:thumbnail_url],
        :include  => {
          :store  => {
            :only     => [:id,:name,:handle,:is_processed],
            :methods  => [:is_top,:thumbnail_url]},
          :user => {
            :only => [:id,:handle]}})-%>
  <%-elsif @filter  == :store-%>
    <%=@products.to_json(
        :only     => [:id,:is_gift,:handle,
                        :user_id,:category_id],
        :methods  => [:giant_url,:thumbnail],
        :include  => {
          :user => {
            :only => [:id,:first_name,:last_name,:handle],
            :methods  => [:photo_url]}})-%>
  <%-elsif @filter == :top || @filter == :used-%>
    <%=@products.to_json(
        :only     => [:id,:title,:handle],
        :include  => {
          :user => {
            :only => [:id,:handle]}})-%>
  <%-end-%>
<%-end-%>
