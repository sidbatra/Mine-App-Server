#!/usr/bin/env ruby

# Test valdidity of arguments
if ARGV.length < 2
  puts "ruby script/dbpull <target database> <mysql password>"
  exit
else
  target_db = ARGV[0]
  password  = ARGV[1]
  host      = "denwen-teams-production.cm7fec8nnv4c.us-east-1.rds.amazonaws.com"
  user      = "root"
  source_db = "hasit_production"
  sql_file  = "production_#{rand(10000)}.sql"
end

# Drop the source database to ensure a clean copy
system("mysql -u #{user} -h #{host} -p#{password} -e 'drop database #{target_db}'")

# Recreate the source database
system("mysql -u #{user} -h #{host} -p#{password} -e 'create database #{target_db}'")

# Dump the production database into a sql file
system("mysqldump -u #{user} -h #{host} -p#{password} #{source_db} > #{sql_file}")

# Copy the production databse into the source database via the sql file
system("mysql -u #{user} -h #{host} -p#{password} #{target_db} < #{sql_file}")

# Clean up
system("rm #{sql_file}")
